<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
	 h2 {
        color: black;
        text-align: center;
      }

     body{ width:1060px; margin:200px auto; }
	 path { stroke: #fff; }
	 path:hover { opacity:0.9; }
	 rect:hover { fill:blue; }
	.axis { font: 10px sans-serif; }
	.legend tr{ border-bottom:1px solid grey; }
	.legend tr:first-child{ border-top:1px solid grey; }
	.axis path, .axis line { fill:none; stroke:#000; 
						shape-rendering:crispEdges; }
	.x.axis path { display: none; }
	
	.legend{
			margin-bottom:76px;
			display:inline-block;
			border-collapse: collapse;
			border-spacing: 0px;
			}
	.legend td{padding:4px 5px; vertical-align:bottom;}
	.legendFreq, .legendPerc{ align:right; width:50px; }
    </style>
	
	
	Select year 
	<select onchange="loadData()" id="year">
			<option >2003</option>
			<option >2004</option>
			<option >2005</option>
			<option >2006</option>
			<option >2007</option>
			<option >2008</option>
			<option >2009</option>
			<option >2010</option>
			<option >2011</option>
			<option >2012</option>
			<option >2013</option>
			<option >2014</option>
			<option >2015</option>
			<option >2016</option>
			<option >2017</option>
	</select>	
    <script type="text/javascript">  
     			
	  //Main function to create the page 		
	 function draw(data) {
	   	var hG, pC, leg, barColor = 'steelblue';
	
		// create google color scale 
		function colors_google(n) {
			var colors_g = ["#109618", "#ff9900", "#dc3912",
			"#990099", "#0099c6", "#dd4477", "#66aa00", "#b82e2e", "#316395",
			"#994499", "#22aa99", "#aaaa11", "#6633cc", "#e67300", "#8b0707",
			"#651067", "#329262", "#5574a6", "#3b3eac","#3366cc"  ];
			return colors_g[n % colors_g.length];}
		
		
		// compute Total for each carrier.
		data.forEach(function(d){d.total=d.arr_flights +d.arr_del15 + 
												d.arr_cancelled;});				
		
	   //Dynamically set the heading for each year 
	   var selectedYear = document.getElementById('year')
								  .selectedOptions[0].text;
								  
		header = "On-Time performance of  American carriers for the year " 
														+ selectedYear
		
		d3.select("h2").remove()
		d3.select("body")
		   .append("h2")
		   .text(header)														
		
		
		// function to handle histogram.		
		function handleHistogram(hGData)	{
		
			var hG={}, hGDim = {t: 60, r: 0, b: 30, l: 10}; 
			hGDim.w = 520 - hGDim.l - hGDim.r, 
			hGDim.h = 300 - hGDim.t - hGDim.b;
			
			d3.select("svg").remove()
			var hGsvg = d3.select("body")				
				.append("svg")
				.attr("width", hGDim.w + hGDim.l + hGDim.r)
				.attr("height", hGDim.h + hGDim.t + hGDim.b).append("g")
				.attr("transform", "translate(" + hGDim.l + "," +hGDim.t+ ")");
				
			// create x axis labels (names of carriers)			
			var x = d3.scale.ordinal().rangeRoundBands([0, hGDim.w], 0.1)
					   .domain(hGData.map(function(d) { return d[0]; }));
			
			// Add x-axis to the histogram svg			
			hGsvg.append("g").attr("class", "x axis")
				 .attr("transform", "translate(0," + hGDim.h + ")")
				 .call(d3.svg.axis().scale(x).orient("bottom"));
		    
			// Create function for y-axis to the svg
			var y = d3.scale.linear().range([hGDim.h, 0])
					 .domain([0, d3.max(hGData, function(d) { return d[1]; })]);
			
			//Create bars for histogram to contain rectangles and Airline names.
				
			var bars = hGsvg.selectAll("bar").data(hGData);			
			
				
			//Draw the Rectangles
			bars.enter()
				.append("g")
				.attr("class", "bar")
				.append("rect")
				.attr("x", function(d) { return x(d[0]); })
				.attr("y", function(d) { return y(d[1]); })
				.attr("width", x.rangeBand())
				.attr("height", function(d) { return hGDim.h - y(d[1]); })
				.attr('fill',barColor)
				
			//Create the  labels above the bars.		
			bars.append("text").text(function(d){return d3.format(".2f")(d[1])})
				.attr("x", function(d) { return x(d[0])+x.rangeBand()/2; })
				.attr("y", function(d) { return y(d[1]) -5; })
				.attr("text-anchor", "middle");		
			
			// Event handler to the bars by moving mouse over it 
			// to update the piechart associated with that bar
			// calls mosueoverPie() defined below		
			
			bars.on('mouseover', mouseoverPie);
			
			function mouseoverPie(d) {
                // d is the bar data (it changes for each bar), 
                // and it contains 5 observations (given the change to how
                // data is passed to the bar chart)

                // create labels for data
                var labels = ["On Time", "Delayed","Cancelled"]

                // for the pie chart, you want the data to be a list of objects
                var pieData = [];

                d.slice(2, 5).forEach(function(d, i) {
                    var temp = {};
                    temp['value'] = d;
                    temp['labels'] = labels[i];
                    pieData.push(temp);
                })

                // call the pieChart() function with the new data
                pieChart(pieData);
                // leg.update(nD);
            }
			
		
			return hG;
		}
		
		// function to handle pieChart.
		 function pieChart(pD) {
            d3.select("svg#pieChart").remove();
			

            var pC = {},
                pieDim = {
                    w: 250,
                    h: 250
                };
            pieDim.r = Math.min(pieDim.w, pieDim.h) / 2;
            console.log("pD");
            console.log(pD);
            console.log(pieDim);

            var rw = pieDim.w / 2;
            var rh = pieDim.h / 2;


            // create svg for pie chart.
            var piesvg = d3.select("body").append("svg:svg").attr("id", "pieChart")
                .data([pD]) //associate our data with the document
                .attr("width", pieDim.w).attr("height", pieDim.h).append("svg:g")
                .attr("transform", "translate(" + rw + "," + rh + ")");
            //move the center of the pie chart from 0, 0 to radius, radius


            // create function to draw the arcs of the pie slices.
            // var arc = d3.svg.arc().outerRadius(50).innerRadius(0);
            var arc = d3.svg.arc().outerRadius(pieDim.r - 10).innerRadius(0);

            // create a function to compute the pie slice angles.
            var pie = d3.layout.pie()
                .sort(null)
                .value(function(d, i) {
                    return d.value;
                });

            // Draw the pie slices.
            var arcs = piesvg.selectAll("g.slice") //this selects all <g> elements with class slice (there aren't any yet)
                .data(pie) //associate the generated pie data (an array of arcs, each having startAngle, endAngle and value properties) 
                .enter() //this will create <g> elements for every "extra" data element that should be associated with a selection. The result is creating a <g> for every object in the data array
                .append("svg:g") //create a group to hold each slice (we will have a <path> and a <text> element associated with each slice)
                .attr("class", "slice"); //allow us to style things in the slices (like text)

            arcs.append("svg:path")
                .attr("fill", function(d, i) {
                    return colors_google(i);
                }) //set the color for each slice to be chosen from the color function defined above
				.transition()
				.delay(function(d, i) {
					return i * 200;
				})
				.duration(500)
                .attr("d", arc) //this creates the actual SVG path using the associated data (pie) with the arc drawing function
				
            arcs.append("svg:text") //add a label to each slice
                .attr("transform", function(d) { //set the label's origin to the center of the arc
                    //we have to make sure to set these before calling arc.centroid
                    d.innerRadius = 0;
                    d.outerRadius = pieDim.r - 10;
                    return "translate(" + arc.centroid(d) + ")"; //this gives us a pair of coordinates like [50, 50]
                })
                
				 //get the percentages for each segment in the pie chart	
                .text(function(d, i) {					
					var formatDecimal = d3.format(".1f")
					var sum = d3.sum(pD, function(d) { return d.value; })					
                    var percent =  100*(pD[i].value)/sum;
					return formatDecimal(percent) + "%"
					
                })		
				
				// Add legend 
				//d3.select("legend").remove();
				// d3.select("svg:svg#pieChart").remove();
				d3.select("svg.legend").remove();
				var legend = d3.select("body").append("svg:svg")
								.attr("class", "legend")          
								.selectAll("g")
								.data(pD)
								.enter().append("g")
						.attr("transform", function(d, i) {return "translate(0," + i * 20 + ")"; });

				legend.append("rect")
				.attr("width", 18)
				.attr("height", 18)
				.style("fill", function(d, i) {
				return colors_google(i);
				});

				legend.append("text")
					  .attr("x", 24)
					 .attr("y", 9)
                     .attr("dy", ".35em")
                     .text(function(d,i) { return pD[i].labels; });  				
			 
            return pC;
        }		
		// Extract histogram data 
		var hGData = data.map(function(d){			
					
				return [d.carrier,d.onTime,d.arr_flights,
						d.arr_del15, d.arr_cancelled];		
		});
		
		//Extract Piechart data 
		var piChartData = data.map(function(d)
		{
		return [d.arr_flights,d.arr_del15,d.arr_cancelled];
		});

		//Create data for Hsitogram, PieChart and legend 
		var hG = handleHistogram(hGData);
		
		
     
    };
    </script>
  </head>
<body>
  <script type="text/javascript">
		
		// load the data for each year according to user input
		var loadData = function() {
		var myYear = document.getElementById('year').selectedOptions[0].text;
		var dataFile = 'airlinePerfoPreprocessed_' + myYear + '.csv'	
		d3.csv(dataFile, draw);
		}
  </script>
</body>
</html>
